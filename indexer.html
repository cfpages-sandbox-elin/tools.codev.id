<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš€ SpeedyIndexer v2</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 95%; /* Increased width */
            max-width: 1200px; /* Increased max-width */
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .tab-container {
            display: flex;
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px 5px 0 0;
            background-color: #f0f0f0;
            cursor: pointer;
            border-bottom: none;
        }

        .tab-button.active {
            background-color: white;
            font-weight: bold;
        }

        .tab-content {
            border: 1px solid #ccc;
            border-radius: 0 5px 5px 5px;
            padding: 20px;
            display: flex; /* Enable flexbox for tab content */
            flex-direction: column; /* Stack elements vertically inside tab content */
        }

        .tab-content.hidden {
            display: none;
        }

        .api-key-area, .balance-area, .status-area, .task-list-area {
            margin-bottom: 15px;
        }

        .url-filter-container { /* Container for URL and Filter side-by-side */
            display: flex;
            gap: 15px; /* Spacing between URL and Filter areas */
            margin-bottom: 15px;
        }

        .url-area, .filter-area {
            flex: 1; /* Equal width for URL and Filter areas */
            min-width: 0; /* Ensure they can shrink if needed */
        }


        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: monospace; /* Monospace font for textareas */
            font-size: 14px;
        }

        textarea {
            height: 200px; /* Increased textarea height */
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }

        button:hover {
            background-color: #e0e0e0;
        }

        #balance-display {
            font-weight: bold;
            display: flex; /* Flex for alignment */
            align-items: center; /* Center align items vertically */
            gap: 10px; /* Spacing between items */
        }

        #balance-display span {
            font-weight: normal; /* Make balance numbers normal weight */
        }


        #task-status {
            white-space: pre-wrap;
            font-family: monospace;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
            height: 100px;
            overflow-y: scroll;
            margin-top: 10px; /* Spacing above task status */
        }

        .url-count-cost {
            margin-top: 10px;
            font-size: 0.9em;
            color: #777;
        }

        .task-list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .task-list-table th, .task-list-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .task-list-table th {
            background-color: #f0f0f0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px; /* Increased tooltip width */
            background-color: black;
            color: #fff;
            text-align: left; /* Left align tooltip text */
            border-radius: 6px;
            padding: 8px; /* Increased tooltip padding */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px; /* Adjusted margin for wider tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em; /* Slightly smaller tooltip font */
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .loading-indicator {
            display: none;
            margin-left: 10px;
        }
        .loading-indicator.active {
            display: inline-block;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ SpeedyIndex Tool v1.3</h1>

        <div class="tab-container">
            <button class="tab-button active" data-tab="indexer">Indexer</button>
            <button class="tab-button" data-tab="past-tasks">Past Tasks ðŸ“œ</button>
        </div>

        <div id="indexer" class="tab-content">
            <div class="api-key-area">
                <label for="api-key" class="tooltip">ðŸ”‘ SpeedyIndex API Key <span class="tooltiptext">This tool uses your SpeedyIndex API key to check balance and submit indexing tasks. The API key is securely stored server-side and is not visible in the client-side code.</span></label>
                <input type="text" id="api-key" placeholder="Your API Key" disabled>
            </div>
            <div class="balance-area">
                <label>ðŸ’° Balance:</label>
                <div id="balance-display">
                    <span>Indexer:</span> <span id="indexer-balance"></span> <span title="Balance for Google link indexing service">ðŸ”—</span>,
                    <span>Checker:</span> <span id="checker-balance"></span> <span title="Balance for Google link indexation check service">âœ…</span>
                </div>
            </div>

            <div class="url-filter-container">
                <div class="url-area">
                    <label for="urls" class="tooltip">ðŸ”— URLs to Index <span class="tooltiptext">Enter URLs to be indexed, one URL per line (maximum 10,000 per task). Newlines in the textarea will be correctly interpreted as line breaks.</span></label>
                    <textarea id="urls" placeholder="https://example.com/page1\nhttps://example.com/page2"></textarea>
                    <div class="url-count-cost">URLs: <span id="url-count">0</span>, Estimated Cost: <span id="estimated-cost">0.00</span> $</div>
                </div>

                <div class="filter-area">
                    <label for="url-filter" class="tooltip"> ðŸš« Filter URLs (Optional) <span class="tooltiptext">Enter keywords or phrases to filter out URLs from the indexing task. URLs containing any of these filters will be excluded. Enter each filter term on a new line. Filtering is non-destructive and only affects the current submission.</span></label>
                    <textarea id="url-filter" placeholder="keyword1\nphrase to exclude\nanother keyword"></textarea>
                </div>
            </div>


            <button id="submit-urls-btn">ðŸš€ Submit URLs for Indexing <span class="loading-indicator" id="submit-loading-indicator">ðŸ”„</span></button>
            <div class="status-area">
                <label>ðŸ“œ Task Status:</label>
                <div id="task-status"></div>
            </div>
        </div>

        <div id="past-tasks" class="tab-content hidden">
            <div class="task-list-area">
                <h2>ðŸ“œ Past Tasks</h2>
                <button id="refresh-tasks-btn">ðŸ”„ Refresh Tasks <span class="loading-indicator" id="refresh-loading-indicator">ðŸ”„</span></button>
                <div id="past-tasks-status"></div>
                <table class="task-list-table" id="task-list">
                    <thead>
                        <tr>
                            <th>Task ID</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Processed</th>
                            <th>Indexed</th>
                            <th>Completed</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7">No tasks yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
      document.addEventListener('DOMContentLoaded', function() {
        const apiKeyInput = document.getElementById('api-key');
        const indexerBalanceDisplay = document.getElementById('indexer-balance');
        const checkerBalanceDisplay = document.getElementById('checker-balance');
        const urlsTextarea = document.getElementById('urls');
        const urlFilterInput = document.getElementById('url-filter');
        const urlCountDisplay = document.getElementById('url-count');
        const estimatedCostDisplay = document.getElementById('estimated-cost');
        const submitUrlsButton = document.getElementById('submit-urls-btn');
        const taskStatusDiv = document.getElementById('task-status');
        const submitLoadingIndicator = document.getElementById('submit-loading-indicator');
        const refreshLoadingIndicator = document.getElementById('refresh-loading-indicator');
        const refreshTasksButton = document.getElementById('refresh-tasks-btn');
        const pastTasksStatusDiv = document.getElementById('past-tasks-status');
        const taskListTableBody = document.querySelector('#task-list tbody');

        const apiKeyLocalStorageKey = 'speedyindex-api-key';
        const pricePerLink = 0.0075; // Price per link for indexing

        // API Key input is now mostly for show/instructions as API key is server-side
        let currentApiKey = "Server-Side API Key"; // Indicate API key is server-side
        apiKeyInput.value = currentApiKey; // Display "Server-Side API Key" or similar

        apiKeyInput.disabled = true; // Disable API Key input as it's server-side

        fetchBalance(); // Fetch balance on page load

        urlsTextarea.addEventListener('input', updateUrlCountAndCost);
        urlFilterInput.addEventListener('input', filterUrls);

        submitUrlsButton.addEventListener('click', submitUrlsForIndexing);
        refreshTasksButton.addEventListener('click', fetchPastTasks);

        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');

                if (tabId === 'past-tasks') {
                    fetchPastTasks(); // Fetch tasks when Past Tasks tab is opened
                }
            });
        });


        function updateUrlCountAndCost() {
            const urls = urlsTextarea.value.trim();
            const urlList = urls.split('\n').filter(url => url.trim() !== '');
            const count = urlList.length;
            urlCountDisplay.textContent = count;
            const estimatedCost = (count * pricePerLink).toFixed(2);
            estimatedCostDisplay.textContent = estimatedCost;
        }

        function filterUrls() {
            const filterTextLines = urlFilterInput.value.toLowerCase().split('\n').filter(line => line.trim() !== '');
            const originalUrls = urlsTextarea.value.split('\n');
            let filteredUrls = '';
            originalUrls.forEach(url => {
                const urlLower = url.toLowerCase();
                let shouldInclude = true;
                for (const filter of filterTextLines) {
                    if (urlLower.includes(filter)) {
                        shouldInclude = false;
                        break; // If any filter matches, exclude the URL
                    }
                }
                if (shouldInclude) {
                    filteredUrls += url + '\n';
                }
            });
            urlsTextarea.value = filteredUrls.trim();
            updateUrlCountAndCost(); // Recalculate count and cost after filtering
        }


        async function fetchBalance() { // API Key not needed as parameter anymore
            indexerBalanceDisplay.textContent = 'Loading...';
            checkerBalanceDisplay.textContent = 'Loading...';
            const apiUrl = '/speedyindex-api?action=get-balance'; // Path to Cloudflare Function with action

            try {
                const response = await fetch(apiUrl); // No API Key in headers

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.balance) {
                    indexerBalanceDisplay.textContent = data.balance.indexer;
                    checkerBalanceDisplay.textContent = data.balance.checker;
                } else if (data.error) {
                    indexerBalanceDisplay.textContent = 'Error';
                    checkerBalanceDisplay.textContent = 'Error';
                    taskStatusDiv.textContent = `Balance Error: ${data.error}`;
                }
                  else {
                    indexerBalanceDisplay.textContent = 'Error';
                    checkerBalanceDisplay.textContent = 'Error';
                    taskStatusDiv.textContent = 'Error fetching balance.';
                }

            } catch (error) {
                console.error("Could not fetch balance:", error);
                indexerBalanceDisplay.textContent = 'Error';
                checkerBalanceDisplay.textContent = 'Error';
                taskStatusDiv.textContent = 'Failed to fetch balance. Check network.';
            }
        }

        async function submitUrlsForIndexing() {
            const urls = urlsTextarea.value.trim().split('\n').filter(url => url.trim() !== '');
            if (urls.length === 0) {
                taskStatusDiv.textContent = 'Please enter URLs to index.';
                return;
            }

            if (urls.length > 10000) {
                taskStatusDiv.textContent = 'Maximum 10,000 URLs per task.';
                return;
            }

            const filterTextLines = urlFilterInput.value.toLowerCase().split('\n').filter(line => line.trim() !== '');
            const filteredUrls = urls.filter(url => {
                const urlLower = url.toLowerCase();
                let shouldInclude = true;
                for (const filter of filterTextLines) {
                    if (urlLower.includes(filter)) {
                        shouldInclude = false;
                        break; // If any filter matches, exclude the URL
                    }
                }
                return shouldInclude;
            });


            if (filteredUrls.length === 0) {
                taskStatusDiv.textContent = 'No URLs to index after applying filters.';
                return;
            }


            submitLoadingIndicator.classList.add('active');
            submitUrlsButton.disabled = true;
            taskStatusDiv.textContent = 'Submitting URLs for indexing...';

            const apiUrl = '/speedyindex-api?action=index-urls'; // Path to Cloudflare Function with action
            const requestBody = JSON.stringify({
                "urls": filteredUrls // Use filtered URLs for submission
            });

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: requestBody
                });

                const data = await response.json();

                if (data.code === 0) {
                    taskStatusDiv.textContent = `URLs submitted successfully! Task ID: ${data.task_id}`;
                    urlsTextarea.value = ''; // Clear textarea after successful submission
                    urlFilterInput.value = ''; // Clear filter textarea too after submission
                    updateUrlCountAndCost(); // Reset count and cost
                } else if (data.code === 1) {
                    taskStatusDiv.textContent = 'Error: Top up balance needed.';
                } else if (data.code === -2) {
                    taskStatusDiv.textContent = 'Error: Server overloaded. Please try again later.';
                }
                  else if (data.error) {
                    taskStatusDiv.textContent = `Error submitting URLs: ${data.error}`;
                }
                  else {
                    taskStatusDiv.textContent = `Error submitting URLs. Code: ${data.code}, Message: ${data.message}`;
                }


            } catch (error) {
                console.error("Error submitting URLs:", error);
                taskStatusDiv.textContent = 'Failed to submit URLs. Check network.';
            } finally {
                submitLoadingIndicator.classList.remove('active');
                submitUrlsButton.disabled = false;
            }
        }

        async function fetchPastTasks() {
            pastTasksStatusDiv.textContent = 'Fetching past tasks...';
            taskListTableBody.innerHTML = '<tr><td colspan="7">Loading tasks...</td></tr>';
            refreshLoadingIndicator.classList.add('active');
            refreshTasksButton.disabled = true;

            const apiUrl = '/speedyindex-api?action=list-tasks'; // Path to Cloudflare Function with action

            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.code === 0 && data.result && data.result.length > 0) {
                    pastTasksStatusDiv.textContent = '';
                    taskListTableBody.innerHTML = ''; // Clear loading row
                    data.result.forEach(task => {
                        const row = taskListTableBody.insertRow();
                        row.insertCell().textContent = task.id;
                        row.insertCell().textContent = task.type;
                        row.insertCell().textContent = task.size;
                        row.insertCell().textContent = task.processed_count;
                        row.insertCell().textContent = task.indexed_count;
                        row.insertCell().textContent = task.is_completed ? 'Yes' : 'No';
                        row.insertCell().textContent = new Date(task.created_at).toLocaleString();
                    });
                } else if (data.code === 0 && (!data.result || data.result.length === 0)) {
                    pastTasksStatusDiv.textContent = 'No tasks found.';
                    taskListTableBody.innerHTML = '<tr><td colspan="7">No tasks yet.</td></tr>';
                }
                  else if (data.error) {
                    pastTasksStatusDiv.textContent = `Error fetching tasks: ${data.error}`;
                    taskListTableBody.innerHTML = '<tr><td colspan="7">Error loading tasks.</td></tr>';
                }
                else {
                    pastTasksStatusDiv.textContent = `Error fetching tasks. Code: ${data.code}, Message: ${data.message}`;
                    taskListTableBody.innerHTML = '<tr><td colspan="7">Error loading tasks.</td></tr>';
                }


            } catch (error) {
                console.error("Error fetching past tasks:", error);
                pastTasksStatusDiv.textContent = 'Failed to fetch tasks. Check network.';
                taskListTableBody.innerHTML = '<tr><td colspan="7">Failed to load tasks.</td></tr>';
        } finally {
            refreshLoadingIndicator.classList.remove('active');
            refreshTasksButton.disabled = false;
        }
    }
      }); // <-- Closing DOMContentLoaded event listener
    </script>
</body>
</html>