<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Article Generator & Spinner ü™Ñ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for compactness and spintax coloring */
        body {
            font-family: 'Inter', sans-serif; /* Default font */
            @apply bg-gray-50 text-gray-800;
        }
        .compact-section {
            @apply bg-white p-3 mb-3 rounded-lg shadow;
        }
        .compact-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .compact-input, .compact-select, .compact-textarea {
            @apply block w-full p-1.5 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        .compact-button {
            @apply inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50;
        }
        .api-key-input {
            @apply compact-input; /* Inherits base style */
            font-family: monospace; /* Use monospace font for keys */
        }
        /* Basic Spintax Highlighting */
        .spintax-level-1 { color: #007bff; } /* Blue */
        .spintax-level-2 { color: #28a745; } /* Green */
        .spintax-level-3 { color: #dc3545; } /* Red */
        .spintax-pipe { color: #ffc107; font-weight: bold; } /* Yellow */

        /* Hide scrollbar for textarea but allow scrolling */
         .compact-textarea::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .compact-textarea {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="p-4">

    <h1 class="text-xl font-bold mb-3 text-center text-indigo-700">AI Article Generator & Spinner ü™Ñüìù‚ú®</h1>

    <section id="step1" class="compact-section">
        <h2 class="text-lg font-semibold mb-2 text-gray-600">Step 1: Define Your Article üéØ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label for="keyword" class="compact-label">Keyword / Product üîë:</label>
                <input type="text" id="keyword" class="compact-input" placeholder="e.g., best ergonomic chairs">
            </div>
            <div>
                <label for="language" class="compact-label">Language üó£Ô∏è:</label>
                <select id="language" class="compact-select">
                    <option value="English">English</option>
                    <option value="Indonesian">Indonesian</option>
                    <option value="Spanish">Spanish</option>
                    <option value="French">French</option>
                    <option value="German">German</option>
                    <option value="custom">Custom...</option>
                </select>
                <input type="text" id="custom_language" class="compact-input mt-1 hidden" placeholder="Enter custom language">
            </div>
            <div>
                <label for="tone" class="compact-label">Tone üòé:</label>
                <select id="tone" class="compact-select">
                    <option value="Professional">Professional</option>
                    <option value="Casual">Casual</option>
                    <option value="Formal">Formal</option>
                    <option value="Humorous">Humorous</option>
                    <option value="Informative">Informative</option>
                     <option value="custom">Custom...</option>
                </select>
                 <input type="text" id="custom_tone" class="compact-input mt-1 hidden" placeholder="Enter custom tone">
            </div>
            <div>
                <label for="format" class="compact-label">Output Format üìÑ:</label>
                <select id="format" class="compact-select">
                    <option value="html">HTML</option>
                    <option value="markdown">Markdown</option>
                </select>
            </div>
             <div class="md:col-span-2">
                <label for="custom_specs" class="compact-label">Other Specifications (Optional) ‚úçÔ∏è:</label>
                <textarea id="custom_specs" rows="2" class="compact-textarea" placeholder="e.g., Target audience is small business owners, mention sustainability..."></textarea>
            </div>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-200">
             <h3 class="text-md font-semibold mb-2 text-gray-600">AI Configuration ü§ñ</h3>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                 <div>
                    <label for="ai_provider" class="compact-label">AI Provider:</label>
                    <select id="ai_provider" class="compact-select">
                        <option value="google">Google</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="xai">xAI</option>
                        </select>
                 </div>
                 <div>
                    <label for="ai_model" class="compact-label">Model:</label>
                    <select id="ai_model" class="compact-select">
                        </select>
                 </div>
                 <div>
                    <label for="api_key" class="compact-label">API Key üîí:</label>
                    <input type="password" id="api_key" class="api-key-input" placeholder="Enter API Key for selected provider">
                 </div>
             </div>
        </div>
        <div class="mt-3 text-right">
            <button id="generateStructureBtn" class="compact-button">Generate Structure üèóÔ∏è</button>
        </div>
    </section>

    <section id="step2" class="compact-section hidden">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold text-gray-600">Step 2: Refine Structure üìê</h2>
            <button id="toggleStructureVisibility" class="text-xs text-indigo-600 hover:underline">Hide</button>
        </div>
        <div id="structureContainer">
             <label for="article_structure" class="compact-label">Generated Structure (Editable):</label>
             <textarea id="article_structure" rows="8" class="compact-textarea" placeholder="AI will generate the article structure here..."></textarea>
             <div class="mt-3 text-right">
                 <button id="generateArticleBtn" class="compact-button">Generate Full Article ‚úçÔ∏è</button>
             </div>
        </div>
         <div id="structureLoading" class="text-center p-4 hidden">
            <p class="text-gray-500">Generating structure... <span class="animate-spin inline-block">‚è≥</span></p>
        </div>
    </section>

    <section id="step3" class="compact-section hidden">
         <h2 class="text-lg font-semibold mb-2 text-gray-600">Step 3: Review & Edit Article üìù</h2>
         <label for="generated_article" class="compact-label">Generated Article (Editable):</label>
         <div id="article_output_container" class="border border-gray-300 rounded-md p-2 bg-gray-50 min-h-[150px] max-h-[400px] overflow-y-auto">
             <textarea id="generated_article" rows="10" class="compact-textarea w-full h-full border-none focus:ring-0" placeholder="AI will generate the full article here..."></textarea>
             <div id="html_preview" class="prose max-w-none hidden p-1"></div>
         </div>
         <div class="mt-1 flex justify-between items-center">
             <label class="flex items-center space-x-2 text-sm">
                 <input type="checkbox" id="preview_html_checkbox" class="rounded text-indigo-600 focus:ring-indigo-500">
                 <span>Preview HTML</span>
             </label>
             <button id="enableSpinningBtn" class="compact-button">Enable Spinning üîÑ</button>
         </div>
          <div id="articleLoading" class="text-center p-4 hidden">
            <p class="text-gray-500">Generating article... <span class="animate-spin inline-block">‚è≥</span></p>
        </div>
    </section>

    <section id="step4" class="compact-section hidden">
         <h2 class="text-lg font-semibold mb-2 text-gray-600">Step 4: Spin Content üåÄ</h2>
         <p class="text-sm text-gray-600 mb-2">Select text in the article area below, then click the "Spin Selected Text" button.</p>
         <div class="mb-2 text-right">
             <button id="spinSelectedBtn" class="compact-button" disabled>Spin Selected Text ‚ú®</button>
         </div>
         <label for="spun_article" class="compact-label">Spinnable Article (Editable):</label>
         <div id="spin_output_container" class="border border-gray-300 rounded-md p-2 bg-gray-50 min-h-[150px] max-h-[400px] overflow-y-auto">
              <div id="spun_article_display" contenteditable="true" class="compact-textarea w-full h-full border-none focus:outline-none focus:ring-0 min-h-[150px]" placeholder="Article content will appear here for spinning..."></div>
         </div>
         <div id="spinLoading" class="text-center p-4 hidden">
            <p class="text-gray-500">Spinning text... <span class="animate-spin inline-block">‚è≥</span></p>
        </div>
         <p class="text-xs text-gray-500 mt-2">Spintax uses <code class="bg-gray-200 px-1 rounded">{option1|option2|option3}</code> format. Nested spins: <code class="bg-gray-200 px-1 rounded">{option1|{nested1|nested2}|option3}</code>. Colors help distinguish levels.</p>
    </section>

    <section class="compact-section mt-4 bg-gray-800 text-white">
        <h3 class="text-md font-semibold mb-2 text-gray-400">Console Log ü™µ</h3>
        <pre id="consoleLog" class="text-xs h-24 overflow-y-auto whitespace-pre-wrap break-all"></pre>
    </section>


    <script>
        // --- Configuration ---
        const aiProviders = {
            google: ['gemini-1.5-pro-latest', 'gemini-1.5-flash-latest', 'gemini-1.0-pro'],
            openai: ['gpt-4o', 'gpt-4-turbo', 'gpt-3.5-turbo'],
            anthropic: ['claude-3-opus-20240229', 'claude-3-sonnet-20240229', 'claude-3-haiku-20240307'],
            deepseek: ['deepseek-coder', 'deepseek-chat'], // Example models
            xai: ['grok-1'] // Example models
            // Add more models based on provider documentation
        };

        // --- DOM Elements ---
        const keywordInput = document.getElementById('keyword');
        const languageSelect = document.getElementById('language');
        const customLanguageInput = document.getElementById('custom_language');
        const toneSelect = document.getElementById('tone');
        const customToneInput = document.getElementById('custom_tone');
        const formatSelect = document.getElementById('format');
        const customSpecsInput = document.getElementById('custom_specs');
        const aiProviderSelect = document.getElementById('ai_provider');
        const aiModelSelect = document.getElementById('ai_model');
        const apiKeyInput = document.getElementById('api_key');

        const generateStructureBtn = document.getElementById('generateStructureBtn');
        const generateArticleBtn = document.getElementById('generateArticleBtn');
        const enableSpinningBtn = document.getElementById('enableSpinningBtn');
        const spinSelectedBtn = document.getElementById('spinSelectedBtn');
        const toggleStructureVisibilityBtn = document.getElementById('toggleStructureVisibility');
        const previewHtmlCheckbox = document.getElementById('preview_html_checkbox');

        const step1Section = document.getElementById('step1');
        const step2Section = document.getElementById('step2');
        const step3Section = document.getElementById('step3');
        const step4Section = document.getElementById('step4');

        const structureContainer = document.getElementById('structureContainer');
        const articleStructureTextarea = document.getElementById('article_structure');
        const generatedArticleTextarea = document.getElementById('generated_article');
        const articleOutputContainer = document.getElementById('article_output_container');
        const htmlPreviewDiv = document.getElementById('html_preview');
        const spinOutputContainer = document.getElementById('spin_output_container');
        const spunArticleDisplay = document.getElementById('spun_article_display'); // Use div for highlighting

        const structureLoading = document.getElementById('structureLoading');
        const articleLoading = document.getElementById('articleLoading');
        const spinLoading = document.getElementById('spinLoading');
        const consoleLog = document.getElementById('consoleLog');

        // --- Helper Functions ---
        function logToConsole(message) {
            console.log(message); // Log to browser console
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.textContent = `[${timestamp}] ${message}\n` + consoleLog.textContent;
            // Keep log trimmed
            const lines = consoleLog.textContent.split('\n');
            if (lines.length > 50) {
                consoleLog.textContent = lines.slice(0, 50).join('\n');
            }
        }

        function showLoading(element, show = true) {
            element.classList.toggle('hidden', !show);
        }

        function disableButtons(disabled = true) {
            generateStructureBtn.disabled = disabled;
            generateArticleBtn.disabled = disabled;
            enableSpinningBtn.disabled = disabled;
            // spinSelectedBtn is handled separately based on selection
        }

        function getSelectedProvider() {
             return aiProviderSelect.value;
        }

        // --- Local Storage for API Keys ---
        function loadApiKey() {
            const provider = getSelectedProvider();
            const keys = JSON.parse(localStorage.getItem('aiApiKeys') || '{}');
            apiKeyInput.value = keys[provider] || '';
            logToConsole(`Loaded API key for ${provider}.`);
        }

        function saveApiKey() {
            const provider = getSelectedProvider();
            const key = apiKeyInput.value.trim();
            const keys = JSON.parse(localStorage.getItem('aiApiKeys') || '{}');
            if (key) {
                keys[provider] = key;
                localStorage.setItem('aiApiKeys', JSON.stringify(keys));
                logToConsole(`Saved API key for ${provider}.`);
            } else {
                // Optionally remove key if field is cleared
                // delete keys[provider];
                // localStorage.setItem('aiApiKeys', JSON.stringify(keys));
                // logToConsole(`Cleared API key for ${provider}.`);
            }
        }

        // --- Dynamic Model Loading ---
        function populateModels() {
            const provider = getSelectedProvider();
            const models = aiProviders[provider] || [];
            aiModelSelect.innerHTML = ''; // Clear existing options
            if (models.length === 0) {
                 const option = document.createElement('option');
                 option.value = '';
                 option.textContent = 'No models listed';
                 aiModelSelect.appendChild(option);
                 aiModelSelect.disabled = true;
            } else {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    aiModelSelect.appendChild(option);
                });
                 aiModelSelect.disabled = false;
            }
            loadApiKey(); // Load key for the newly selected provider
        }

        // --- Placeholder AI Call Functions ---
        // These functions simulate calling an AI by constructing a prompt
        // and returning dummy data after a short delay.
        // Replace these with actual API calls in a real application.

        async function generateStructure(prompt) {
            logToConsole(`--- Generating Structure Prompt ---\n${prompt}\n---------------------------------`);
            showLoading(structureLoading);
            disableButtons(true);
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            showLoading(structureLoading, false);
            disableButtons(false);
             // Return dummy structure
            return `Section 1: Introduction to [Keyword]
    - Brief overview
    - Importance/Relevance
Section 2: Key Feature 1
    - Detail A
    - Detail B
Section 3: Key Feature 2
    - Detail C
    - Detail D
Section 4: Comparison (Optional)
    - [Keyword] vs. Alternatives
Section 5: Conclusion
    - Summary
    - Call to Action`;
        }

        async function generateArticle(prompt, format) {
            logToConsole(`--- Generating Article Prompt ---\n${prompt}\n---------------------------------`);
            showLoading(articleLoading);
            disableButtons(true);
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 3000));
            showLoading(articleLoading, false);
            disableButtons(false);

            // Return dummy article based on format
            if (format === 'html') {
                return `<p>This is the <b>introduction</b> to the article about the specified keyword. It highlights the <i>importance</i>.</p>
<h2>Section Title 1</h2>
<p>This paragraph discusses the first key point in detail. Here's a list:</p>
<ul><li>Point 1</li><li>Point 2</li></ul>
<h2>Section Title 2</h2>
<p>This paragraph covers another important aspect.</p>
<p>Finally, a concluding paragraph summarizing the key takeaways.</p>`;
            } else { // markdown
                return `This is the **introduction** to the article about the specified keyword. It highlights the *importance*.

## Section Title 1

This paragraph discusses the first key point in detail. Here's a list:
* Point 1
* Point 2

## Section Title 2

This paragraph covers another important aspect.

Finally, a concluding paragraph summarizing the key takeaways.`;
            }
        }

        async function spinText(prompt) {
             logToConsole(`--- Spinning Text Prompt ---\n${prompt}\n---------------------------------`);
             showLoading(spinLoading);
             disableButtons(true);
             spinSelectedBtn.disabled = true; // Keep spin button disabled during spin
             // Simulate API call delay
             await new Promise(resolve => setTimeout(resolve, 1000));
             showLoading(spinLoading, false);
             disableButtons(false);
             // spinSelectedBtn remains disabled until new selection

             // Return dummy spintax
             return `{original text|variation one|another way to say it|a third alternative}`;
        }

        // --- Spintax Highlighting ---
        function highlightSpintax(element) {
            let html = element.innerHTML;
            // Basic highlighting - might need refinement for complex nesting
            // Replace pipes first to avoid issues with tag attributes
            html = html.replace(/\|/g, '<span class="spintax-pipe">|</span>');

            let level = 0;
            let coloredHtml = '';
            for (let i = 0; i < html.length; i++) {
                if (html[i] === '{') {
                    level++;
                    const colorClass = `spintax-level-${level % 3 + 1}`; // Cycle through 3 colors
                    coloredHtml += `<span class="${colorClass}">{</span>`;
                } else if (html[i] === '}') {
                     if (level > 0) {
                         const colorClass = `spintax-level-${level % 3 + 1}`;
                         coloredHtml += `<span class="${colorClass}">}</span>`;
                         level--;
                     } else {
                         coloredHtml += '}'; // Avoid closing unopened spans
                     }
                } else {
                    coloredHtml += html[i];
                }
            }
             element.innerHTML = coloredHtml; // Re-apply highlighted HTML
        }

        // --- Event Listeners ---

        // Custom input toggles
        languageSelect.addEventListener('change', () => {
            customLanguageInput.classList.toggle('hidden', languageSelect.value !== 'custom');
        });
        toneSelect.addEventListener('change', () => {
            customToneInput.classList.toggle('hidden', toneSelect.value !== 'custom');
        });

        // AI Provider/Model/Key Handling
        aiProviderSelect.addEventListener('change', populateModels);
        apiKeyInput.addEventListener('input', saveApiKey); // Save on input

        // Step 1 -> Step 2: Generate Structure
        generateStructureBtn.addEventListener('click', async () => {
            const keyword = keywordInput.value.trim();
            if (!keyword) {
                alert('Please enter a keyword or product.');
                return;
            }

            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const customSpecs = customSpecsInput.value.trim();
            const provider = getSelectedProvider();
            const model = aiModelSelect.value;
            const apiKey = apiKeyInput.value.trim(); // Although saved, good to check if present for the call

             if (!apiKey) {
                alert(`Please enter an API key for ${provider}. It will be saved in local storage.`);
                apiKeyInput.focus();
                return;
            }

            const prompt = `Generate a detailed article structure/outline for the keyword: "${keyword}".
            - Language: ${language}
            - Tone: ${tone}
            ${customSpecs ? `- Other Specifications: ${customSpecs}` : ''}
            - The structure should be logical and cover the topic comprehensively.
            - Output only the structure, using clear headings or bullet points. No introductory or concluding remarks about the structure itself.`;

            const structure = await generateStructure(prompt);
            articleStructureTextarea.value = structure;
            step2Section.classList.remove('hidden');
            structureContainer.classList.remove('hidden'); // Ensure container is visible
            toggleStructureVisibilityBtn.textContent = 'Hide'; // Reset button text
            step3Section.classList.add('hidden'); // Hide subsequent steps
            step4Section.classList.add('hidden');
        });

        // Step 2 -> Step 3: Generate Article
        generateArticleBtn.addEventListener('click', async () => {
            const structure = articleStructureTextarea.value.trim();
            if (!structure) {
                alert('Article structure is empty. Please generate or edit the structure.');
                return;
            }

            const keyword = keywordInput.value.trim(); // Get other details again for context
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const format = formatSelect.value;
            const customSpecs = customSpecsInput.value.trim();
             const provider = getSelectedProvider();
             const model = aiModelSelect.value;
             const apiKey = apiKeyInput.value.trim();

             if (!apiKey) {
                alert(`Please enter an API key for ${provider}.`);
                apiKeyInput.focus();
                return;
            }

            const prompt = `Generate a full article based on the following structure and specifications:
            - Keyword: "${keyword}"
            - Language: ${language}
            - Tone: ${tone}
            - Output Format: ${format}
            ${customSpecs ? `- Other Specifications: ${customSpecs}` : ''}

            Article Structure:
            ---
            ${structure}
            ---

            Instructions:
            - Write content for each section of the structure.
            - Ensure the article flows well and is coherent.
            - Adhere strictly to the requested output format (${format}).
            ${format === 'html' ? '- For HTML: Use only basic text formatting tags like <p>, <h1>-<h6>, <ul>, <ol>, <li>, <b>, <i>, <a>. Do NOT include <html>, <head>, <body>, or <div> tags.' : '- For Markdown: Use standard Markdown syntax.'}
            - Generate only the article content itself.`;


            const article = await generateArticle(prompt, format);
            generatedArticleTextarea.value = article;

            // Handle preview visibility based on format
            const isHtml = format === 'html';
            previewHtmlCheckbox.checked = false; // Default to off
            previewHtmlCheckbox.disabled = !isHtml;
            previewHtmlCheckbox.parentElement.classList.toggle('hidden', !isHtml); // Hide checkbox if not HTML
            generatedArticleTextarea.classList.toggle('hidden', false); // Always show textarea initially
            htmlPreviewDiv.classList.toggle('hidden', true); // Hide preview initially
            htmlPreviewDiv.innerHTML = ''; // Clear previous preview

            step3Section.classList.remove('hidden');
            step4Section.classList.add('hidden'); // Hide spinning step initially
            // Optionally collapse Step 2
            // structureContainer.classList.add('hidden');
            // toggleStructureVisibilityBtn.textContent = 'Show';
        });

        // Toggle Structure Visibility
        toggleStructureVisibilityBtn.addEventListener('click', () => {
            const isHidden = structureContainer.classList.toggle('hidden');
            toggleStructureVisibilityBtn.textContent = isHidden ? 'Show' : 'Hide';
        });

         // HTML Preview Toggle
        previewHtmlCheckbox.addEventListener('change', () => {
            const showPreview = previewHtmlCheckbox.checked;
            generatedArticleTextarea.classList.toggle('hidden', showPreview);
            htmlPreviewDiv.classList.toggle('hidden', !showPreview);
            if (showPreview) {
                htmlPreviewDiv.innerHTML = generatedArticleTextarea.value; // Render HTML
            }
        });

        // Step 3 -> Step 4: Enable Spinning
        enableSpinningBtn.addEventListener('click', () => {
            spunArticleDisplay.innerHTML = generatedArticleTextarea.value; // Copy content to the display div
            step4Section.classList.remove('hidden');
            highlightSpintax(spunArticleDisplay); // Initial highlight if content already has spintax
            logToConsole("Spinning enabled. Select text in the 'Spinnable Article' area.");
             // Disable preview checkbox as we move to spinning
            previewHtmlCheckbox.checked = false;
            previewHtmlCheckbox.disabled = true;
            generatedArticleTextarea.classList.add('hidden'); // Hide original textarea
            htmlPreviewDiv.classList.add('hidden'); // Hide preview
        });


        // --- Text Selection and Spinning Logic ---
        let selectedText = '';
        let selectionStart = 0;
        let selectionEnd = 0;

        spunArticleDisplay.addEventListener('mouseup', handleSelection);
        spunArticleDisplay.addEventListener('keyup', handleSelection); // Handle selection changes via keyboard

        function handleSelection() {
            const selection = window.getSelection();
            if (selection && selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                 // Ensure selection is within our editable div
                if (spunArticleDisplay.contains(range.commonAncestorContainer)) {
                    selectedText = selection.toString().trim();

                    // Get precise start/end relative to the container's textContent
                    const tempDiv = document.createElement("div");
                    tempDiv.appendChild(range.cloneContents());
                    // This is tricky because innerHTML != textContent. We need a robust way
                    // to map selection back to the raw HTML/text for replacement.
                    // For simplicity now, we'll just enable the button if text is selected.
                    // A full implementation would need careful range handling.

                    if (selectedText.length > 0) {
                        spinSelectedBtn.disabled = false;
                        logToConsole(`Selected: "${selectedText}"`);
                    } else {
                        spinSelectedBtn.disabled = true;
                    }
                    return; // Exit if selection handled
                }
            }
            // If no valid selection or selection outside the target
            selectedText = '';
            spinSelectedBtn.disabled = true;
        }


        spinSelectedBtn.addEventListener('click', async () => {
            if (!selectedText) return;

            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const provider = getSelectedProvider();
            const model = aiModelSelect.value;
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert(`Please enter an API key for ${provider}.`);
                apiKeyInput.focus();
                return;
            }

            const prompt = `Take the following text and generate 2-4 variations that mean the same thing, suitable for spintax.
            - Language: ${language}
            - Tone: ${tone} (Maintain this tone)
            - Output Format: Return ONLY the spintax string in the format {original|variation1|variation2|...}. Do not include any explanation.

            Text to Spin:
            ---
            ${selectedText}
            ---`;

            const spintaxResult = await spinText(prompt);

            // --- Replace Selection Logic ---
            // This is the complex part. Replacing selection in a contentEditable div
            // while preserving surrounding structure and handling nested spintax is non-trivial.
            // A simple document.execCommand('insertText', false, spintaxResult) might work
            // for basic cases but can mess up formatting or existing spintax.
            // For this example, we'll use the simpler approach. A robust solution
            // might involve Range manipulation or a dedicated editor library.

            const selection = window.getSelection();
            if (selection && selection.rangeCount > 0 && spunArticleDisplay.contains(selection.anchorNode)) {
                 // Restore selection before inserting (might be lost after async) - This is tricky
                 // document.execCommand might work if focus hasn't shifted drastically
                try {
                    if (document.queryCommandSupported('insertText')) {
                         document.execCommand('insertText', false, spintaxResult);
                         logToConsole(`Inserted spintax: ${spintaxResult}`);
                    } else {
                        // Fallback or error
                         logToConsole("Error: insertText command not supported.");
                         // As a basic fallback, append (less ideal)
                         // spunArticleDisplay.innerHTML += spintaxResult;
                    }
                } catch (e) {
                    logToConsole(`Error inserting spintax: ${e}`);
                    // Fallback: Manually update innerHTML (might lose selection/cursor position)
                    // This is a very basic fallback and might not be accurate
                     spunArticleDisplay.innerHTML = spunArticleDisplay.innerHTML.replace(selectedText, spintaxResult);

                }

                 // Re-highlight after modification
                 highlightSpintax(spunArticleDisplay);
                 selectedText = ''; // Clear selection
                 spinSelectedBtn.disabled = true; // Disable button after use
            } else {
                 logToConsole("Could not get valid selection to replace.");
                 alert("Could not apply spintax. Please try selecting the text again.");
                 spinSelectedBtn.disabled = true;
            }
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            populateModels(); // Populate models for the default provider
            logToConsole("App initialized. Ready for input.");
        });

    </script>

</body>
</html>
