<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Article Generator & Spinner v3 (CF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles remain largely the same as v2, omitting unchanged styles for brevity */
        body { font-family: 'Inter', sans-serif; @apply bg-gray-100 text-gray-800; }
        .compact-section { @apply bg-white p-4 mb-4 rounded-lg shadow-md; }
        .compact-label { @apply block text-sm font-medium text-gray-700 mb-1; }
        .compact-input, .compact-select, .compact-textarea { @apply block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm; }
        .custom-input-visible { @apply compact-input mt-1; }
        .compact-button { @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed; }
        .spintax-level-1 { color: #007bff; } .spintax-level-2 { color: #28a745; } .spintax-level-3 { color: #dc3545; } .spintax-pipe { color: #ffc107; font-weight: bold; }
        .compact-textarea::-webkit-scrollbar { display: none; } .compact-textarea { -ms-overflow-style: none; scrollbar-width: none; }
        .input-group { @apply mb-3; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #consoleLogContainer { @apply compact-section mt-4 bg-gray-800 text-white p-3; }
        #consoleLog { @apply text-xs h-32 overflow-y-auto whitespace-pre-wrap break-all font-mono; }
        .log-error { @apply text-red-400; } .log-warn { @apply text-yellow-400; } .log-info { @apply text-blue-300; } .log-success { @apply text-green-400; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 max-w-4xl mx-auto">

    <h1 class="text-2xl font-bold mb-4 text-center text-indigo-700">AI Article Generator & Spinner (v3)</h1>

    <section id="step1" class="compact-section">
        <h2 class="text-lg font-semibold mb-3 text-gray-600 border-b pb-2">Step 1: Define Your Article üéØ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
            <div class="input-group">
                <label for="keyword" class="compact-label">Keyword / Product üîë:</label>
                <input type="text" id="keyword" class="compact-input" placeholder="e.g., best ergonomic chairs">
            </div>
            <div class="input-group">
                <label for="language" class="compact-label">Language üó£Ô∏è:</label>
                <select id="language" class="compact-select">
                    <option value="English">English</option>
                    <option value="Indonesian">Indonesian</option>
                    <option value="Spanish">Spanish</option>
                    <option value="French">French</option>
                    <option value="German">German</option>
                    <option value="custom">Custom...</option>
                </select>
                <input type="text" id="custom_language" class="custom-input-visible hidden" placeholder="Enter custom language">
            </div>
            <div class="input-group">
                <label for="tone" class="compact-label">Tone üòé:</label>
                <select id="tone" class="compact-select">
                    <option value="Professional">Professional</option>
                    <option value="Casual">Casual</option>
                    <option value="Formal">Formal</option>
                    <option value="Humorous">Humorous</option>
                    <option value="Informative">Informative</option>
                     <option value="custom">Custom...</option>
                </select>
                 <input type="text" id="custom_tone" class="custom-input-visible hidden" placeholder="Enter custom tone">
            </div>
            <div class="input-group">
                <label for="format" class="compact-label">Output Format üìÑ:</label>
                <select id="format" class="compact-select">
                    <option value="html">HTML</option>
                    <option value="markdown">Markdown</option>
                </select>
            </div>
             <div class="input-group md:col-span-2">
                <label for="custom_specs" class="compact-label">Other Specifications (Optional) ‚úçÔ∏è:</label>
                <textarea id="custom_specs" rows="2" class="compact-textarea" placeholder="e.g., Target audience is small business owners, mention sustainability..."></textarea>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200">
             <h3 class="text-md font-semibold mb-3 text-gray-600">AI Configuration ü§ñ</h3>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4"> <div class="input-group">
                    <label for="ai_provider" class="compact-label">AI Provider:</label>
                    <select id="ai_provider" class="compact-select">
                        <option value="google">Google</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="xai">xAI (Grok)</option>
                    </select>
                 </div>
                 <div class="input-group">
                    <label for="ai_model" class="compact-label">Model:</label>
                    <select id="ai_model" class="compact-select">
                        </select>
                 </div>
                 </div>
             <p class="text-xs text-gray-500 mt-1">API Keys are now handled securely by the backend function.</p>
        </div>
        <div class="mt-4 text-right">
            <button id="generateStructureBtn" class="compact-button">
                Generate Structure üèóÔ∏è
                <span id="structureLoadingIndicator" class="hidden"><span class="loader"></span></span>
            </button>
        </div>
    </section>

    <section id="step2" class="compact-section hidden">
        <div class="flex justify-between items-center mb-2 border-b pb-2">
            <h2 class="text-lg font-semibold text-gray-600">Step 2: Refine Structure üìê</h2>
            <button id="toggleStructureVisibility" class="text-sm text-indigo-600 hover:underline">Hide</button>
        </div>
        <div id="structureContainer">
             <label for="article_structure" class="compact-label">Generated Structure (Editable):</label>
             <textarea id="article_structure" rows="8" class="compact-textarea" placeholder="AI will generate the article structure here..."></textarea>
             <div class="mt-3 text-right">
                 <button id="generateArticleBtn" class="compact-button">
                     Generate Full Article ‚úçÔ∏è
                     <span id="articleLoadingIndicator" class="hidden"><span class="loader"></span></span>
                 </button>
             </div>
        </div>
    </section>

    <section id="step3" class="compact-section hidden">
         <h2 class="text-lg font-semibold mb-3 text-gray-600 border-b pb-2">Step 3: Review & Edit Article üìù</h2>
         <label for="generated_article" class="compact-label">Generated Article (Editable):</label>
         <div id="article_output_container" class="border border-gray-300 rounded-md p-1 bg-gray-50 min-h-[200px] max-h-[450px] overflow-y-auto">
             <textarea id="generated_article" rows="12" class="compact-textarea w-full h-full border-none focus:ring-0 bg-transparent" placeholder="AI will generate the full article here..."></textarea>
             <div id="html_preview" class="prose max-w-none hidden p-2"></div>
         </div>
         <div class="mt-2 flex justify-between items-center">
             <label class="flex items-center space-x-2 text-sm cursor-pointer">
                 <input type="checkbox" id="preview_html_checkbox" class="rounded text-indigo-600 focus:ring-indigo-500">
                 <span>Preview HTML</span>
             </label>
             <button id="enableSpinningBtn" class="compact-button">
                 Enable Spinning üîÑ
                  <span id="spinLoadingIndicator" class="hidden"><span class="loader"></span></span>
            </button>
         </div>
    </section>

    <section id="step4" class="compact-section hidden">
         <h2 class="text-lg font-semibold mb-3 text-gray-600 border-b pb-2">Step 4: Spin Content üåÄ</h2>
         <p class="text-sm text-gray-600 mb-2">Select text in the article area below, then click the "Spin Selected Text" button.</p>
         <div class="mb-2 text-right">
             <button id="spinSelectedBtn" class="compact-button" disabled>
                 Spin Selected Text ‚ú®
                 <span id="spinActionLoadingIndicator" class="hidden"><span class="loader"></span></span>
             </button>
         </div>
         <label for="spun_article_display" class="compact-label">Spinnable Article (Editable):</label>
         <div id="spin_output_container" class="border border-gray-300 rounded-md p-2 bg-gray-50 min-h-[200px] max-h-[450px] overflow-y-auto">
              <div id="spun_article_display" contenteditable="true" class="compact-textarea w-full h-full border-none focus:outline-none focus:ring-0 min-h-[200px]" placeholder="Article content will appear here for spinning..."></div>
         </div>
         <p class="text-xs text-gray-500 mt-2">Spintax: <code class="bg-gray-200 px-1 rounded">{opt1|opt2}</code> Nested: <code class="bg-gray-200 px-1 rounded">{opt1|{nest1|nest2}|opt3}</code>. Colors distinguish levels.</p>
    </section>

    <div id="consoleLogContainer">
        <h3 class="text-md font-semibold mb-2 text-gray-400">Console Log ü™µ</h3>
        <pre id="consoleLog"></pre>
    </div>


    <script>
        // --- Configuration (Frontend Only - Models List) ---
        const aiProviders = {
            // Only need model lists now
            google: { models: ['gemini-2.5-pro-preview-03-25', 'gemini-2.0-flash', 'gemini-2.0-flash-lite', 'gemini-2.0-flash-thinking-exp-01-21'] },
            openai: { models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4.1', 'gpt-4.1-mini', 'gpt-4.1-nano'] },
            anthropic: { models: ['claude-3-opus-20240229', 'claude-3-sonnet-20240229', 'claude-3-haiku-20240307'] },
            deepseek: { models: ['deepseek-chat', 'deepseek-coder'] },
            xai: { models: ['grok-3', 'grok-3-mini', 'grok-3-fast', 'grok-3-mini-fast'] }
        };

        // --- DOM Elements (Mostly unchanged) ---
        const keywordInput = document.getElementById('keyword');
        const languageSelect = document.getElementById('language');
        const customLanguageInput = document.getElementById('custom_language');
        const toneSelect = document.getElementById('tone');
        const customToneInput = document.getElementById('custom_tone');
        const formatSelect = document.getElementById('format');
        const customSpecsInput = document.getElementById('custom_specs');
        const aiProviderSelect = document.getElementById('ai_provider');
        const aiModelSelect = document.getElementById('ai_model');
        // API Key Input Removed

        const generateStructureBtn = document.getElementById('generateStructureBtn');
        const generateArticleBtn = document.getElementById('generateArticleBtn');
        const enableSpinningBtn = document.getElementById('enableSpinningBtn');
        const spinSelectedBtn = document.getElementById('spinSelectedBtn');
        const toggleStructureVisibilityBtn = document.getElementById('toggleStructureVisibility');
        const previewHtmlCheckbox = document.getElementById('preview_html_checkbox');

        const step1Section = document.getElementById('step1');
        const step2Section = document.getElementById('step2');
        const step3Section = document.getElementById('step3');
        const step4Section = document.getElementById('step4');

        const structureContainer = document.getElementById('structureContainer');
        const articleStructureTextarea = document.getElementById('article_structure');
        const generatedArticleTextarea = document.getElementById('generated_article');
        const articleOutputContainer = document.getElementById('article_output_container');
        const htmlPreviewDiv = document.getElementById('html_preview');
        const spinOutputContainer = document.getElementById('spin_output_container');
        const spunArticleDisplay = document.getElementById('spun_article_display');

        const structureLoadingIndicator = document.getElementById('structureLoadingIndicator');
        const articleLoadingIndicator = document.getElementById('articleLoadingIndicator');
        const spinLoadingIndicator = document.getElementById('spinLoadingIndicator');
        const spinActionLoadingIndicator = document.getElementById('spinActionLoadingIndicator');

        const consoleLog = document.getElementById('consoleLog');

        // --- Helper Functions (logToConsole, showLoading, disableButtons are the same) ---
        function logToConsole(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.classList.add(`log-${type}`);
            logEntry.textContent = `[${timestamp}] ${message}`;
            consoleLog.prepend(logEntry);
            while (consoleLog.children.length > 50) {
                consoleLog.removeChild(consoleLog.lastChild);
            }
        }

        function showLoading(indicatorElement, show = true) {
            indicatorElement.classList.toggle('hidden', !show);
        }

        function disableButtons(disabled = true) {
            generateStructureBtn.disabled = disabled;
            generateArticleBtn.disabled = disabled;
            enableSpinningBtn.disabled = disabled;
        }

        function getSelectedProviderKey() {
             return aiProviderSelect.value;
        }

        // --- API Key Handling Removed ---

        // --- Dynamic Model Loading (Simpler) ---
        function populateModels() {
            const providerKey = getSelectedProviderKey();
            const providerConfig = aiProviders[providerKey]; // Get from simplified config
            const models = providerConfig?.models || [];
            aiModelSelect.innerHTML = ''; // Clear existing options

            if (models.length === 0) {
                 const option = document.createElement('option');
                 option.value = '';
                 option.textContent = 'No models listed';
                 aiModelSelect.appendChild(option);
                 aiModelSelect.disabled = true;
            } else {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    aiModelSelect.appendChild(option);
                });
                 aiModelSelect.disabled = false;
            }
            // No need to load API key here anymore
        }

        // --- Updated AI Call Function (Calls Cloudflare Function) ---
        async function callAI(prompt, loadingIndicator, buttonToDisable) {
            const providerKey = getSelectedProviderKey();
            const model = aiModelSelect.value;

            if (!providerKey || !model) {
                logToConsole('Missing Provider or Model selection.', 'error');
                alert('Please select a provider and model.');
                return null;
            }

            const requestBody = {
                providerKey: providerKey,
                model: model,
                prompt: prompt
            };

            logToConsole(`Sending request to Cloudflare Function for ${providerKey} (${model})...`, 'info');
            showLoading(loadingIndicator, true);
            if (buttonToDisable) buttonToDisable.disabled = true; else disableButtons(true);

            try {
                const response = await fetch('/functions/ai-api', { // Call the CF function endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json(); // Always expect JSON back

                if (!response.ok || !data.success) {
                    const errorMsg = data.error || `Request failed with status ${response.status}`;
                    throw new Error(errorMsg); // Throw error to be caught below
                }

                logToConsole(`Successfully received response via Cloudflare Function.`, 'success');
                return data.text; // Return the text from the successful response

            } catch (error) {
                console.error("AI Call via Function Failed:", error);
                logToConsole(`AI Call Error: ${error.message}`, 'error');
                alert(`API Call Failed: ${error.message}. Check the console log for more details.`);
                return null; // Indicate failure
            } finally {
                showLoading(loadingIndicator, false);
                 if (buttonToDisable) buttonToDisable.disabled = false; else disableButtons(false);
            }
        }


        // --- Spintax Highlighting (Unchanged from v2 fix) ---
        function highlightSpintax(element) {
             element.querySelectorAll('.spintax-level-1, .spintax-level-2, .spintax-level-3, .spintax-pipe').forEach(el => {
                 el.outerHTML = el.innerHTML;
            });
            let html = element.innerHTML;
            const tagMap = {}; let tagIndex = 0;
            html = html.replace(/<[^>]+>/g, (match) => { const placeholder = `__TAG${tagIndex}__`; tagMap[placeholder] = match; tagIndex++; return placeholder; });
            html = html.replace(/\|/g, '<span class="spintax-pipe">|</span>');
            let level = 0; let coloredHtml = '';
            for (let i = 0; i < html.length; i++) {
                if (html[i] === '{') { level++; const colorClass = `spintax-level-${level % 3 + 1}`; coloredHtml += `<span class="${colorClass}">{</span>`; }
                else if (html[i] === '}') { if (level > 0) { const colorClass = `spintax-level-${level % 3 + 1}`; coloredHtml += `<span class="${colorClass}">}</span>`; level--; } else { coloredHtml += '}'; } }
                else { coloredHtml += html[i]; }
            }
            coloredHtml = coloredHtml.replace(/__TAG\d+__/g, (placeholder) => tagMap[placeholder] || placeholder);
            element.innerHTML = coloredHtml;
        }

        // --- Event Listeners (Unchanged, except API key listener removed) ---

        languageSelect.addEventListener('change', () => { customLanguageInput.classList.toggle('hidden', languageSelect.value !== 'custom'); });
        toneSelect.addEventListener('change', () => { customToneInput.classList.toggle('hidden', toneSelect.value !== 'custom'); });
        aiProviderSelect.addEventListener('change', populateModels);
        // apiKeyInput listener removed

        // Step 1 -> Step 2: Generate Structure (Uses updated callAI)
        generateStructureBtn.addEventListener('click', async () => {
            const keyword = keywordInput.value.trim();
            if (!keyword) { alert('Please enter a keyword or product.'); return; }
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const customSpecs = customSpecsInput.value.trim();
            const prompt = `Generate a detailed article structure/outline for the keyword: "${keyword}".\n- Language: ${language}\n- Tone: ${tone}\n${customSpecs ? `- Other Specifications: ${customSpecs}` : ''}\n- The structure should be logical and cover the topic comprehensively.\n- Output only the structure, using clear headings or bullet points (like Section 1: ..., - Point A, - Point B). No introductory or concluding remarks about the structure itself.`;
            logToConsole(`--- Generating Structure Prompt ---\n${prompt}\n---------------------------------`);
            const structure = await callAI(prompt, structureLoadingIndicator, generateStructureBtn);
            if (structure) {
                articleStructureTextarea.value = structure;
                step2Section.classList.remove('hidden');
                structureContainer.classList.remove('hidden');
                toggleStructureVisibilityBtn.textContent = 'Hide';
                step3Section.classList.add('hidden'); step4Section.classList.add('hidden');
            }
        });

        // Step 2 -> Step 3: Generate Article (Uses updated callAI)
        generateArticleBtn.addEventListener('click', async () => {
            const structure = articleStructureTextarea.value.trim();
            if (!structure) { alert('Article structure is empty.'); return; }
            const keyword = keywordInput.value.trim();
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const format = formatSelect.value;
            const customSpecs = customSpecsInput.value.trim();
            const prompt = `Generate a full article based on the following structure and specifications:\n- Keyword: "${keyword}"\n- Language: ${language}\n- Tone: ${tone}\n- Output Format: ${format}\n${customSpecs ? `- Other Specifications: ${customSpecs}` : ''}\n\nArticle Structure:\n---\n${structure}\n---\n\nInstructions:\n- Write content for each section of the structure.\n- Ensure the article flows well and is coherent.\n- Adhere strictly to the requested output format (${format}).\n${format === 'html' ? '- For HTML: Use only basic text formatting tags like <p>, <h1>-<h6>, <ul>, <ol>, <li>, <b>, <i>, <a>. Do NOT include <html>, <head>, <body>, or <div> tags.' : '- For Markdown: Use standard Markdown syntax.'}\n- Generate only the article content itself, without any introductory or concluding remarks about the generation process.`;
            logToConsole(`--- Generating Article Prompt ---\n${prompt}\n---------------------------------`);
            const article = await callAI(prompt, articleLoadingIndicator, generateArticleBtn);
            if (article) {
                generatedArticleTextarea.value = article;
                const isHtml = format === 'html';
                previewHtmlCheckbox.checked = false; previewHtmlCheckbox.disabled = !isHtml;
                previewHtmlCheckbox.parentElement.classList.toggle('hidden', !isHtml);
                generatedArticleTextarea.classList.remove('hidden');
                htmlPreviewDiv.classList.add('hidden'); htmlPreviewDiv.innerHTML = '';
                step3Section.classList.remove('hidden'); step4Section.classList.add('hidden');
            }
        });

        // Toggle Structure Visibility (Unchanged)
        toggleStructureVisibilityBtn.addEventListener('click', () => { const isHidden = structureContainer.classList.toggle('hidden'); toggleStructureVisibilityBtn.textContent = isHidden ? 'Show' : 'Hide'; });

         // HTML Preview Toggle (Unchanged)
        previewHtmlCheckbox.addEventListener('change', () => {
            const showPreview = previewHtmlCheckbox.checked;
            generatedArticleTextarea.classList.toggle('hidden', showPreview);
            htmlPreviewDiv.classList.toggle('hidden', !showPreview);
            if (showPreview) {
                let unsafeHTML = generatedArticleTextarea.value;
                let sanitizedHTML = unsafeHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                htmlPreviewDiv.innerHTML = sanitizedHTML;
                 logToConsole("Showing HTML preview. Basic script tag removal applied.", "warn");
            }
        });

        // Step 3 -> Step 4: Enable Spinning (Unchanged)
        enableSpinningBtn.addEventListener('click', () => {
            spunArticleDisplay.innerHTML = generatedArticleTextarea.value;
            step4Section.classList.remove('hidden');
            highlightSpintax(spunArticleDisplay);
            logToConsole("Spinning enabled. Select text in the 'Spinnable Article' area.", 'info');
            generatedArticleTextarea.classList.add('hidden');
            htmlPreviewDiv.classList.add('hidden');
            previewHtmlCheckbox.parentElement.classList.add('hidden');
            previewHtmlCheckbox.checked = false;
        });


        // --- Text Selection and Spinning Logic (Uses updated callAI) ---
        let selectedTextInfo = null;
        spunArticleDisplay.addEventListener('mouseup', handleSelection);
        spunArticleDisplay.addEventListener('keyup', handleSelection);
        spunArticleDisplay.addEventListener('focus', handleSelection);

        function handleSelection() {
            const selection = window.getSelection();
            if (selection && selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                if (spunArticleDisplay.contains(range.commonAncestorContainer) && !range.collapsed) {
                    const text = selection.toString().trim();
                    if (text.length > 0) {
                        selectedTextInfo = { text: text, range: range.cloneRange() };
                        spinSelectedBtn.disabled = false; return;
                    }
                }
            }
            selectedTextInfo = null; spinSelectedBtn.disabled = true;
        }

        spinSelectedBtn.addEventListener('click', async () => {
            if (!selectedTextInfo || !selectedTextInfo.text) { logToConsole("Spin button clicked but no valid text selected.", "warn"); return; }
            const textToSpin = selectedTextInfo.text;
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const prompt = `Take the following text and generate 2-4 variations that mean the same thing, suitable for spintax.\n- Language: ${language}\n- Tone: ${tone} (Maintain this tone)\n- Output Format: Return ONLY the spintax string in the format {original|variation1|variation2|...}. Do not include the original text you were given unless it's one of the variations. Do not include any explanation or surrounding text.\n\nText to Spin:\n---\n${textToSpin}\n---`;
            logToConsole(`--- Spinning Text Prompt ---\n${prompt}\n---------------------------------`);
            const spintaxResult = await callAI(prompt, spinActionLoadingIndicator, spinSelectedBtn);
            if (spintaxResult) {
                const selection = window.getSelection();
                if (selection && selectedTextInfo.range) {
                    try {
                         selection.removeAllRanges(); selection.addRange(selectedTextInfo.range);
                         if (document.queryCommandSupported('insertHTML')) { document.execCommand('insertHTML', false, spintaxResult); }
                         else if (document.queryCommandSupported('insertText')) { logToConsole("insertHTML not supported, using insertText.", "warn"); document.execCommand('insertText', false, spintaxResult); }
                         else { selectedTextInfo.range.deleteContents(); selectedTextInfo.range.insertNode(document.createTextNode(spintaxResult)); }
                         logToConsole(`Inserted spintax: ${spintaxResult}`, 'success');
                         highlightSpintax(spunArticleDisplay);
                    } catch (e) { logToConsole(`Error replacing selection with spintax: ${e}`, 'error'); alert("Error applying spintax."); }
                    finally { selectedTextInfo = null; spinSelectedBtn.disabled = true; selection.removeAllRanges(); }
                } else { logToConsole("Could not restore selection range.", 'error'); alert("Could not apply spintax."); spinSelectedBtn.disabled = true; }
            } else { spinSelectedBtn.disabled = true; }
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            populateModels(); // Populate models for the default provider
            logToConsole("App initialized (v3 - Cloudflare Function). Ready for input.", 'info');
            logToConsole("API calls are now proxied securely via /functions/ai-api.", 'info');
        });

    </script>

</body>
</html>
