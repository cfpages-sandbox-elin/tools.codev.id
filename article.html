<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Article Generator & Spinner v5 (CF++)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles remain largely the same as v4 */
        body { font-family: 'Inter', sans-serif; @apply bg-gray-100 text-gray-800; }
        .compact-section { @apply bg-white p-4 mb-4 rounded-lg shadow-md; }
        .compact-label { @apply block text-sm font-medium text-gray-700 mb-1 whitespace-nowrap; } /* Prevent wrap */
        .compact-input, .compact-select, .compact-textarea { @apply block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm; }
        .custom-input-visible { @apply compact-input mt-1; }
        .compact-button { @apply inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed; }
        .spintax-level-1 { color: #007bff; } .spintax-level-2 { color: #28a745; } .spintax-level-3 { color: #dc3545; } .spintax-pipe { color: #ffc107; font-weight: bold; }
        .compact-textarea::-webkit-scrollbar { display: none; } .compact-textarea { -ms-overflow-style: none; scrollbar-width: none; }
        .input-group { @apply mb-3; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; margin-left: 6px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #consoleLogContainer { @apply compact-section mt-4 bg-gray-800 text-white p-3; }
        #consoleLog { @apply text-xs h-32 overflow-y-auto whitespace-pre-wrap break-all font-mono; }
        .log-error { @apply text-red-400; } .log-warn { @apply text-yellow-400; } .log-info { @apply text-blue-300; } .log-success { @apply text-green-400; }
        .status-ok { @apply text-green-600 font-semibold; } .status-error { @apply text-red-600 font-semibold; } .status-checking { @apply text-yellow-600 italic; }
        #sitemapUrlsList { @apply text-xs max-h-32 overflow-y-auto border border-gray-200 bg-gray-50 p-2 rounded mt-1; }
        #sitemapUrlsList div { @apply mb-1 truncate; }
        .toggle-switch { @apply relative inline-flex items-center h-6 rounded-full w-11 cursor-pointer; }
        .toggle-switch input { @apply sr-only; }
        .toggle-switch .slider { @apply absolute inset-0 bg-gray-300 rounded-full transition-colors duration-200 ease-in-out; }
        .toggle-switch input:checked + .slider { @apply bg-indigo-600; }
        .toggle-switch .dot { @apply absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform duration-200 ease-in-out; }
        .toggle-switch input:checked + .slider .dot { @apply transform translate-x-5; }
        /* Styling for multi-select (basic) */
        .multi-select-container { @apply block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white; }
        .multi-select-container label { @apply flex items-center space-x-2 text-sm cursor-pointer mb-1; }
        .multi-select-container input[type="checkbox"] { @apply rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 max-w-4xl mx-auto">

    <h1 class="text-2xl font-bold mb-4 text-center text-indigo-700">AI Article Generator & Spinner (v5)</h1>

    <section id="step1" class="compact-section">
        <h2 class="text-lg font-semibold mb-3 text-gray-600 border-b pb-2">Step 1: Define Your Article üéØ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div>
                <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="keyword" class="compact-label">Keyword üîë<span class="text-red-500">*</span>:</label>
                    <input type="text" id="keyword" class="compact-input col-span-2" placeholder="e.g., best ergonomic chairs">
                </div>
                 <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="language" class="compact-label">Language üó£Ô∏è<span class="text-red-500">*</span>:</label>
                    <div class="col-span-2">
                        <select id="language" class="compact-select w-full">
                        </select>
                        <input type="text" id="custom_language" class="custom-input-visible hidden w-full" placeholder="Enter custom language">
                     </div>
                </div>
                 <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="dialect" class="compact-label">Dialect:</label>
                    <select id="dialect" class="compact-select col-span-2" disabled>
                        <option value="">-- Select Language First --</option>
                    </select>
                </div>
                <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="audience" class="compact-label">Audience üë•<span class="text-red-500">*</span>:</label>
                    <input type="text" id="audience" class="compact-input col-span-2" placeholder="e.g., Small business owners, Gamers">
                </div>
                <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="readerName" class="compact-label">Reader Name üôá:</label>
                    <input type="text" id="readerName" class="compact-input col-span-2" placeholder="e.g., Boss, Bro, Anda (leave blank for general)">
                </div>
                 <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="sitemapUrl" class="compact-label">Sitemap URL üîó:</label>
                    <div class="col-span-2 flex items-center gap-x-2">
                        <input type="url" id="sitemapUrl" class="compact-input flex-grow" placeholder="https://example.com/sitemap.xml">
                        <button id="fetchSitemapBtn" class="compact-button flex-shrink-0">
                            Fetch
                            <span id="sitemapLoadingIndicator" class="hidden"><span class="loader"></span></span>
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="tone" class="compact-label">Tone üéôÔ∏è<span class="text-red-500">*</span>:</label>
                     <div class="col-span-2">
                        <select id="tone" class="compact-select w-full">
                            <option value="Professional">Professional</option>
                            <option value="Casual">Casual</option>
                            <option value="Formal">Formal</option>
                            <option value="Humorous">Humorous</option>
                            <option value="Informative">Informative</option>
                            <option value="Persuasive">Persuasive</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <input type="text" id="custom_tone" class="custom-input-visible hidden w-full" placeholder="Enter custom tone">
                    </div>
                </div>
                <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="gender" class="compact-label">Author Gender üöª:</label>
                    <select id="gender" class="compact-select col-span-2">
                        <option value="">Any</option>
                        <option value="Male">‚ôÇÔ∏è Male</option>
                        <option value="Female">‚ôÄÔ∏è Female</option>
                    </select>
                </div>
                 <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="age" class="compact-label">Author Age üéÇ:</label>
                    <select id="age" class="compact-select col-span-2">
                        <option value="">Any</option>
                        <option value="18-24">18-24</option>
                        <option value="25-34">25-34</option>
                        <option value="35-44">35-44</option>
                        <option value="45+">45+</option>
                    </select>
                </div>
                <div class="input-group grid grid-cols-3 items-start gap-x-2">
                    <label for="purpose" class="compact-label pt-1">Purpose üí°<span class="text-red-500">*</span>:</label>
                    <div class="col-span-2 multi-select-container">
                        <label><input type="checkbox" name="purpose" value="Inform"> Inform Reader</label>
                        <label><input type="checkbox" name="purpose" value="Promote Site/Product"> Promote Site/Product</label>
                        <label><input type="checkbox" name="purpose" value="Promote URL"> Promote Specific URL</label>
                        <label><input type="checkbox" name="purpose" value="Generate Leads"> Generate Leads</label>
                        <label><input type="checkbox" name="purpose" value="Build Authority"> Build Authority</label>
                        <input type="text" id="purposeUrl" class="compact-input mt-1 hidden" placeholder="URL to promote/link to">
                        <input type="text" id="purposeCta" class="compact-input mt-1 hidden" placeholder="Call to action text (e.g., Visit now!)">
                    </div>
                </div>
                <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="format" class="compact-label">Format <span class="text-red-500">*</span>:</label>
                    <select id="format" class="compact-select col-span-2">
                        <option value="html">HTML</option>
                        <option value="markdown">Markdown</option>
                    </select>
                </div>

            </div>

             <div class="input-group grid grid-cols-3 items-start gap-x-2 md:col-span-2 mt-4">
                <label for="custom_specs" class="compact-label pt-1">Other Details:</label>
                <textarea id="custom_specs" rows="2" class="compact-textarea col-span-2" placeholder="Any other specific instructions..."></textarea>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-200">
             <div class="flex justify-between items-center mb-3">
                 <h3 class="text-md font-semibold text-gray-600">AI Configuration ü§ñ</h3>
                 <div id="apiStatus" class="text-sm">
                     <span class="status-checking">Checking status...</span>
                     <span id="apiStatusIndicator" class="hidden"><span class="loader !w-4 !h-4"></span></span>
                 </div>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                 <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="ai_provider" class="compact-label">AI Provider:</label>
                    <select id="ai_provider" class="compact-select col-span-2">
                        <option value="google">Google</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="xai">xAI (Grok)</option>
                    </select>
                 </div>
                 <div class="input-group grid grid-cols-3 items-center gap-x-2">
                    <label for="ai_model" class="compact-label">Model:</label>
                    <select id="ai_model" class="compact-select col-span-2">
                        </select>
                 </div>
             </div>
             <p class="text-xs text-gray-500 mt-1">API Keys are handled securely by the backend function.</p>
        </div>
        <div class="mt-4 text-right">
            <button id="generateStructureBtn" class="compact-button">
                Generate Structure üèóÔ∏è
                <span id="structureLoadingIndicator" class="hidden"><span class="loader"></span></span>
            </button>
        </div>
    </section>

    <section id="step2" class="compact-section hidden">
         <div class="flex justify-between items-center mb-2 border-b pb-2">
            <h2 class="text-lg font-semibold text-gray-600">Step 2: Refine Structure & Links üìêüîó</h2>
            <button id="toggleStructureVisibility" class="text-sm text-indigo-600 hover:underline">Hide</button>
        </div>
        <div id="structureContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
                 <label for="article_structure" class="compact-label">Generated Structure (Editable):</label>
                 <textarea id="article_structure" rows="10" class="compact-textarea" placeholder="AI will generate the article structure here..."></textarea>
            </div>
             <div class="md:col-span-1">
                 <label for="sitemapUrlsList" class="compact-label">Sitemap URLs (for Linking):</label>
                 <div id="sitemapUrlsList" class="mb-2">
                     <em class="text-gray-400">No sitemap loaded.</em>
                 </div>
                 <div class="flex items-center justify-between text-sm">
                     <span class="text-gray-700">Link Type:</span>
                     <label for="linkTypeToggle" class="toggle-switch">
                         <input type="checkbox" id="linkTypeToggle">
                         <span class="slider"><span class="dot"></span></span>
                     </label>
                     <span id="linkTypeText" class="font-medium text-indigo-700 w-16 text-right">Internal</span>
                 </div>
                 <p class="text-xs text-gray-500 mt-1">Toggle for Internal (relative) or External (absolute) links.</p>
             </div>
        </div>
         <div class="mt-3 text-right">
             <button id="generateArticleBtn" class="compact-button">
                 Generate Full Article ‚úçÔ∏è
                 <span id="articleLoadingIndicator" class="hidden"><span class="loader"></span></span>
             </button>
         </div>
    </section>
    <section id="step3" class="compact-section hidden">
         <h2 class="text-lg font-semibold mb-3 text-gray-600 border-b pb-2">Step 3: Review & Edit Article üìù</h2>
         <label for="generated_article" class="compact-label">Generated Article (Editable):</label>
         <div id="article_output_container" class="border border-gray-300 rounded-md p-1 bg-gray-50 min-h-[200px] max-h-[450px] overflow-y-auto">
             <textarea id="generated_article" rows="12" class="compact-textarea w-full h-full border-none focus:ring-0 bg-transparent" placeholder="AI will generate the full article here..."></textarea>
             <div id="html_preview" class="prose max-w-none hidden p-2"></div>
         </div>
         <div class="mt-2 flex justify-between items-center">
             <label class="flex items-center space-x-2 text-sm cursor-pointer">
                 <input type="checkbox" id="preview_html_checkbox" class="rounded text-indigo-600 focus:ring-indigo-500">
                 <span>Preview HTML</span>
             </label>
             <button id="enableSpinningBtn" class="compact-button">
                 Enable Spinning üîÑ
                  <span id="spinLoadingIndicator" class="hidden"><span class="loader"></span></span>
            </button>
         </div>
    </section>
    <section id="step4" class="compact-section hidden">
         <h2 class="text-lg font-semibold mb-3 text-gray-600 border-b pb-2">Step 4: Spin Content üåÄ</h2>
         <p class="text-sm text-gray-600 mb-2">Select text in the article area below, then click the "Spin Selected Text" button.</p>
         <div class="mb-2 text-right">
             <button id="spinSelectedBtn" class="compact-button" disabled>
                 Spin Selected Text ‚ú®
                 <span id="spinActionLoadingIndicator" class="hidden"><span class="loader"></span></span>
             </button>
         </div>
         <label for="spun_article_display" class="compact-label">Spinnable Article (Editable):</label>
         <div id="spin_output_container" class="border border-gray-300 rounded-md p-2 bg-gray-50 min-h-[200px] max-h-[450px] overflow-y-auto">
              <div id="spun_article_display" contenteditable="true" class="compact-textarea w-full h-full border-none focus:outline-none focus:ring-0 min-h-[200px]" placeholder="Article content will appear here for spinning..."></div>
         </div>
         <p class="text-xs text-gray-500 mt-2">Spintax: <code class="bg-gray-200 px-1 rounded">{opt1|opt2}</code> Nested: <code class="bg-gray-200 px-1 rounded">{opt1|{nest1|nest2}|opt3}</code>.</p>
    </section>

    <div id="consoleLogContainer">
        <h3 class="text-md font-semibold mb-2 text-gray-400">Console Log ü™µ</h3>
        <pre id="consoleLog"></pre>
    </div>


    <script>
        // --- Configuration ---
        const aiProviders = {
            google: { models: ['gemini-2.5-pro-preview-03-25', 'gemini-2.0-flash', 'gemini-2.0-flash-lite', 'gemini-2.0-flash-thinking-exp-01-21'] },
            openai: { models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4.1', 'gpt-4.1-mini', 'gpt-4.1-nano'] },
            anthropic: { models: ['claude-3-opus-20240229', 'claude-3-sonnet-20240229', 'claude-3-haiku-20240307'] },
            deepseek: { models: ['deepseek-chat', 'deepseek-coder'] },
            xai: { models: ['grok-3', 'grok-3-mini', 'grok-3-fast', 'grok-3-mini-fast'] }
        };
        const SITEMAP_STORAGE_KEY = 'aiArticleSpinner_sitemapUrls_v1';

        // Language and Dialect Configuration
        const languageOptions = {
            "English": { name: "English", dialects: ["Default", "American", "British", "Australian"] },
            "Indonesian": { name: "Indonesian", dialects: ["Default/Formal", "Jaksel", "Suroboyoan", "Medan", "Santai/Gaul"] },
            "Spanish": { name: "Spanish", dialects: ["Default/Neutral", "Spain", "Mexican", "Argentinian"] },
            "French": { name: "French", dialects: ["Default/Standard", "Canadian", "African"] },
            "German": { name: "German", dialects: ["Default/Standard", "Bavarian", "Swiss German"] },
            "custom": { name: "Custom...", dialects: [] } // Handle custom language case
        };

        // --- DOM Elements ---
        const keywordInput = document.getElementById('keyword');
        const languageSelect = document.getElementById('language');
        const customLanguageInput = document.getElementById('custom_language');
        const dialectSelect = document.getElementById('dialect'); // New
        const audienceInput = document.getElementById('audience'); // New
        const readerNameInput = document.getElementById('readerName'); // New
        const toneSelect = document.getElementById('tone');
        const customToneInput = document.getElementById('custom_tone');
        const genderSelect = document.getElementById('gender'); // New
        const ageSelect = document.getElementById('age'); // New
        const purposeCheckboxes = document.querySelectorAll('input[name="purpose"]'); // New (NodeList)
        const purposeUrlInput = document.getElementById('purposeUrl'); // New
        const purposeCtaInput = document.getElementById('purposeCta'); // New
        const formatSelect = document.getElementById('format');
        const customSpecsInput = document.getElementById('custom_specs');
        const aiProviderSelect = document.getElementById('ai_provider');
        const aiModelSelect = document.getElementById('ai_model');
        const sitemapUrlInput = document.getElementById('sitemapUrl');
        const fetchSitemapBtn = document.getElementById('fetchSitemapBtn');
        const apiStatusDiv = document.getElementById('apiStatus');
        const apiStatusIndicator = document.getElementById('apiStatusIndicator');
        const sitemapUrlsListDiv = document.getElementById('sitemapUrlsList');
        const linkTypeToggle = document.getElementById('linkTypeToggle');
        const linkTypeText = document.getElementById('linkTypeText');
        // ... (rest of DOM elements are the same) ...
        const generateStructureBtn = document.getElementById('generateStructureBtn');
        const generateArticleBtn = document.getElementById('generateArticleBtn');
        const enableSpinningBtn = document.getElementById('enableSpinningBtn');
        const spinSelectedBtn = document.getElementById('spinSelectedBtn');
        const toggleStructureVisibilityBtn = document.getElementById('toggleStructureVisibility');
        const previewHtmlCheckbox = document.getElementById('preview_html_checkbox');
        const step1Section = document.getElementById('step1');
        const step2Section = document.getElementById('step2');
        const step3Section = document.getElementById('step3');
        const step4Section = document.getElementById('step4');
        const structureContainer = document.getElementById('structureContainer');
        const articleStructureTextarea = document.getElementById('article_structure');
        const generatedArticleTextarea = document.getElementById('generated_article');
        const articleOutputContainer = document.getElementById('article_output_container');
        const htmlPreviewDiv = document.getElementById('html_preview');
        const spinOutputContainer = document.getElementById('spin_output_container');
        const spunArticleDisplay = document.getElementById('spun_article_display');
        const structureLoadingIndicator = document.getElementById('structureLoadingIndicator');
        const articleLoadingIndicator = document.getElementById('articleLoadingIndicator');
        const sitemapLoadingIndicator = document.getElementById('sitemapLoadingIndicator');
        const spinLoadingIndicator = document.getElementById('spinLoadingIndicator');
        const spinActionLoadingIndicator = document.getElementById('spinActionLoadingIndicator');
        const consoleLog = document.getElementById('consoleLog');


        // --- State ---
        let parsedSitemapUrls = [];

        // --- Helper Functions ---
        function logToConsole(message, type = 'info') { console.log(`[${type.toUpperCase()}] ${message}`); const timestamp = new Date().toLocaleTimeString(); const logEntry = document.createElement('div'); logEntry.classList.add(`log-${type}`); logEntry.textContent = `[${timestamp}] ${message}`; consoleLog.prepend(logEntry); while (consoleLog.children.length > 100) { consoleLog.removeChild(consoleLog.lastChild); } }
        function showLoading(indicatorElement, show = true) { indicatorElement.classList.toggle('hidden', !show); }
        function disableButtons(disabled = true) { generateStructureBtn.disabled = disabled; generateArticleBtn.disabled = disabled; enableSpinningBtn.disabled = disabled; }
        function getSelectedProviderKey() { return aiProviderSelect.value; }

        // --- API Status Function ---
        async function checkApiStatus() {
            const providerKey = getSelectedProviderKey();
            const model = aiModelSelect.value; // Use the currently selected model for the check

            if (!providerKey || !model) {
                apiStatusDiv.innerHTML = `<span class="status-error">Select Provider/Model</span>`;
                return; // Don't check if no model selected
            }

            apiStatusDiv.innerHTML = `<span class="status-checking">Checking ${providerKey}...</span>`;
            showLoading(apiStatusIndicator, true);

            try {
                const response = await fetch('/ai-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'check_status',
                        providerKey: providerKey,
                        model: model
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || `Status check failed (${response.status})`);
                }

                apiStatusDiv.innerHTML = `<span class="status-ok">‚úÖ Ready (${providerKey})</span>`;
                logToConsole(`API Status OK for ${providerKey} (${model})`, 'success');

            } catch (error) {
                console.error("API Status Check Failed:", error);
                logToConsole(`API Status Error: ${error.message}`, 'error');
                apiStatusDiv.innerHTML = `<span class="status-error">‚ùå Error: ${error.message}</span>`;
            } finally {
                 showLoading(apiStatusIndicator, false);
            }
        }


        // --- Sitemap Functions ---
        function displaySitemapUrls() { /* ... (same as v4) ... */ if (parsedSitemapUrls.length === 0) { sitemapUrlsListDiv.innerHTML = `<em class="text-gray-400">No sitemap loaded or no URLs found.</em>`; return; } sitemapUrlsListDiv.innerHTML = ''; parsedSitemapUrls.forEach(url => { const div = document.createElement('div'); div.textContent = url; sitemapUrlsListDiv.appendChild(div); }); }
        function loadSitemapFromStorage() { /* ... (same as v4) ... */ const storedUrls = localStorage.getItem(SITEMAP_STORAGE_KEY); if (storedUrls) { parsedSitemapUrls = JSON.parse(storedUrls); logToConsole(`Loaded ${parsedSitemapUrls.length} sitemap URLs from local storage.`, 'info'); } else { parsedSitemapUrls = []; } displaySitemapUrls(); }
        async function fetchAndParseSitemap() { /* ... (same as v4) ... */ const url = sitemapUrlInput.value.trim(); if (!url) { alert('Please enter a Sitemap URL.'); return; } logToConsole(`Fetching sitemap from URL: ${url}`, 'info'); showLoading(sitemapLoadingIndicator, true); fetchSitemapBtn.disabled = true; try { const response = await fetch('/ai-api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'fetch_sitemap', sitemapUrl: url }) }); const data = await response.json(); if (!response.ok || !data.success) { throw new Error(data.error || `Failed to fetch/parse sitemap (${response.status})`); } parsedSitemapUrls = data.urls || []; localStorage.setItem(SITEMAP_STORAGE_KEY, JSON.stringify(parsedSitemapUrls)); logToConsole(`Successfully fetched and parsed ${parsedSitemapUrls.length} URLs.`, 'success'); displaySitemapUrls(); } catch (error) { console.error("Sitemap Fetch/Parse Failed:", error); logToConsole(`Sitemap Error: ${error.message}`, 'error'); alert(`Failed to process sitemap: ${error.message}`); } finally { showLoading(sitemapLoadingIndicator, false); fetchSitemapBtn.disabled = false; } }

        // --- Language/Dialect Functions ---
        function populateLanguages() {
            languageSelect.innerHTML = ''; // Clear existing
            Object.keys(languageOptions).forEach(langKey => {
                const option = document.createElement('option');
                option.value = langKey; // Use the key as value
                option.textContent = languageOptions[langKey].name;
                languageSelect.appendChild(option);
            });
            // Trigger initial dialect population
            populateDialects();
        }

        function populateDialects() {
            const selectedLangKey = languageSelect.value;
            const langConfig = languageOptions[selectedLangKey];
            const dialects = langConfig?.dialects || [];

            dialectSelect.innerHTML = ''; // Clear existing dialects

            if (selectedLangKey === 'custom' || dialects.length === 0) {
                dialectSelect.disabled = true;
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "-- N/A --";
                dialectSelect.appendChild(option);
            } else {
                dialectSelect.disabled = false;
                dialects.forEach(dialect => {
                    const option = document.createElement('option');
                    option.value = dialect; // Use dialect name as value
                    option.textContent = dialect;
                    dialectSelect.appendChild(option);
                });
            }
             // Handle custom language input visibility
             customLanguageInput.classList.toggle('hidden', selectedLangKey !== 'custom');
             customLanguageInput.classList.toggle('custom-input-visible', selectedLangKey === 'custom');
        }

        // --- Dynamic Model Loading ---
        function populateModels() { /* ... (same as v4, calls checkApiStatus) ... */ const providerKey = getSelectedProviderKey(); const providerConfig = aiProviders[providerKey]; const models = providerConfig?.models || []; aiModelSelect.innerHTML = ''; if (models.length === 0) { const option = document.createElement('option'); option.value = ''; option.textContent = 'No models listed'; aiModelSelect.appendChild(option); aiModelSelect.disabled = true; } else { models.forEach(model => { const option = document.createElement('option'); option.value = model; option.textContent = model; aiModelSelect.appendChild(option); }); aiModelSelect.disabled = false; } checkApiStatus(); }

        // --- Unified AI Call Function ---
        async function callAI(action, payload, loadingIndicator, buttonToDisable) { /* ... (same as v4) ... */ const fullPayload = { action, ...payload }; logToConsole(`Sending action '${action}' to Cloudflare Function...`, 'info'); if(loadingIndicator) showLoading(loadingIndicator, true); if (buttonToDisable) buttonToDisable.disabled = true; else disableButtons(true); try { const response = await fetch('/ai-api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(fullPayload) }); const data = await response.json(); if (!response.ok || !data.success) { const errorMsg = data.error || `Request failed with status ${response.status}`; throw new Error(errorMsg); } logToConsole(`Action '${action}' completed successfully.`, 'success'); return data; } catch (error) { console.error(`Action '${action}' Failed:`, error); logToConsole(`Error during action '${action}': ${error.message}`, 'error'); alert(`Operation Failed: ${error.message}. Check console log.`); return null; } finally { if(loadingIndicator) showLoading(loadingIndicator, false); if (buttonToDisable) buttonToDisable.disabled = false; else disableButtons(false); } }

        // --- Spintax Highlighting ---
        function highlightSpintax(element) { /* ... (same as v4) ... */ element.querySelectorAll('.spintax-level-1, .spintax-level-2, .spintax-level-3, .spintax-pipe').forEach(el => { el.outerHTML = el.innerHTML; }); let html = element.innerHTML; const tagMap = {}; let tagIndex = 0; html = html.replace(/<[^>]+>/g, (match) => { const placeholder = `__TAG${tagIndex}__`; tagMap[placeholder] = match; tagIndex++; return placeholder; }); html = html.replace(/\|/g, '<span class="spintax-pipe">|</span>'); let level = 0; let coloredHtml = ''; for (let i = 0; i < html.length; i++) { if (html[i] === '{') { level++; const colorClass = `spintax-level-${level % 3 + 1}`; coloredHtml += `<span class="${colorClass}">{</span>`; } else if (html[i] === '}') { if (level > 0) { const colorClass = `spintax-level-${level % 3 + 1}`; coloredHtml += `<span class="${colorClass}">}</span>`; level--; } else { coloredHtml += '}'; } } else { coloredHtml += html[i]; } } coloredHtml = coloredHtml.replace(/__TAG\d+__/g, (placeholder) => tagMap[placeholder] || placeholder); element.innerHTML = coloredHtml; }

        // --- Validation Function ---
        function validateInputs() {
            let isValid = true;
            let missingFields = [];

            // Required fields check
            if (!keywordInput.value.trim()) { missingFields.push("Keyword"); isValid = false; }
            if (!languageSelect.value || (languageSelect.value === 'custom' && !customLanguageInput.value.trim())) { missingFields.push("Language"); isValid = false; }
            if (!audienceInput.value.trim()) { missingFields.push("Audience"); isValid = false; }
            if (!toneSelect.value || (toneSelect.value === 'custom' && !customToneInput.value.trim())) { missingFields.push("Tone"); isValid = false; }
            if (!formatSelect.value) { missingFields.push("Format"); isValid = false; } // Should always have a value, but good practice

            // Purpose validation
            const selectedPurposes = getSelectedPurposes();
            if (selectedPurposes.length === 0) {
                 missingFields.push("Purpose (select at least one)"); isValid = false;
            } else {
                if (selectedPurposes.includes("Promote URL") && !purposeUrlInput.value.trim()) {
                     missingFields.push("Purpose URL (required when 'Promote URL' is selected)"); isValid = false;
                }
            }


            if (!isValid) {
                alert(`Please fill in the required fields (*):\n- ${missingFields.join('\n- ')}`);
            }
            return isValid;
        }

        // --- Get Selected Purposes ---
        function getSelectedPurposes() {
            const selected = [];
            purposeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        // --- Event Listeners ---
        languageSelect.addEventListener('change', populateDialects); // Update dialects on language change
        aiProviderSelect.addEventListener('change', populateModels); // Checks API status
        aiModelSelect.addEventListener('change', (event) => { // Log model change
             logToConsole(`Selected AI Model: ${event.target.value}`, 'info');
             // Optionally re-check status if model change might affect compatibility
             checkApiStatus();
        });
        fetchSitemapBtn.addEventListener('click', fetchAndParseSitemap);
        linkTypeToggle.addEventListener('change', () => { linkTypeText.textContent = linkTypeToggle.checked ? 'External' : 'Internal'; });
        toneSelect.addEventListener('change', () => { customToneInput.classList.toggle('hidden', toneSelect.value !== 'custom'); customToneInput.classList.toggle('custom-input-visible', toneSelect.value === 'custom'); }); // Listener for custom tone

        // Purpose checkbox listeners to show/hide related inputs
        purposeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const selectedPurposes = getSelectedPurposes();
                purposeUrlInput.classList.toggle('hidden', !selectedPurposes.includes('Promote URL'));
                purposeCtaInput.classList.toggle('hidden', !selectedPurposes.some(p => p.startsWith('Promote') || p === 'Generate Leads')); // Show CTA for promotion/leads
            });
        });

        // Step 1 -> Step 2: Generate Structure
        generateStructureBtn.addEventListener('click', async () => {
            if (!validateInputs()) return; // Perform validation

            // Gather all inputs
            const keyword = keywordInput.value.trim();
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageOptions[languageSelect.value]?.name || languageSelect.value;
            const dialect = dialectSelect.disabled ? '' : dialectSelect.value;
            const audience = audienceInput.value.trim();
            const readerName = readerNameInput.value.trim();
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const gender = genderSelect.value;
            const age = ageSelect.value;
            const selectedPurposes = getSelectedPurposes();
            const purposeDetails = {
                types: selectedPurposes,
                url: selectedPurposes.includes("Promote URL") ? purposeUrlInput.value.trim() : '',
                cta: purposeCtaInput.classList.contains('hidden') ? '' : purposeCtaInput.value.trim()
            };
            const customSpecs = customSpecsInput.value.trim();

            // Construct Prompt
            const prompt = `Generate a detailed article structure/outline based on these specifications:
            - Keyword: "${keyword}"
            - Language: ${language}${dialect ? ` (${dialect} dialect)` : ''}
            - Target Audience: ${audience}
            - Tone: ${tone}
            ${gender ? `- Author Gender Persona: ${gender}` : ''}
            ${age ? `- Author Age Persona: ${age}` : ''}
            - Article Purpose(s): ${purposeDetails.types.join(', ')}
            ${purposeDetails.url ? `  - Promotional URL: ${purposeDetails.url}` : ''}
            ${purposeDetails.cta ? `  - Desired Call to Action: ${purposeDetails.cta}` : ''}
            ${readerName ? `- Address Reader As: ${readerName}` : ''}
            ${customSpecs ? `- Other Details: ${customSpecs}` : ''}

            Instructions:
            - Create a logical structure covering the keyword comprehensively for the specified audience.
            - Output only the structure using clear headings or bullet points (e.g., Section 1: ..., - Point A, - Point B).
            - Do not include introductory or concluding remarks about the structure itself.`;

            const payload = {
                providerKey: getSelectedProviderKey(),
                model: aiModelSelect.value,
                prompt: prompt
            };
            logToConsole(`--- Generating Structure Prompt ---\n${prompt}\n---------------------------------`);
            const result = await callAI('generate', payload, structureLoadingIndicator, generateStructureBtn);

            if (result && result.text) {
                articleStructureTextarea.value = result.text;
                step2Section.classList.remove('hidden');
                structureContainer.classList.remove('hidden');
                toggleStructureVisibilityBtn.textContent = 'Hide';
                step3Section.classList.add('hidden'); step4Section.classList.add('hidden');
                displaySitemapUrls();
            }
        });

        // Step 2 -> Step 3: Generate Article
        generateArticleBtn.addEventListener('click', async () => {
            const structure = articleStructureTextarea.value.trim();
            if (!structure) { alert('Article structure is empty.'); return; }
            if (!validateInputs()) return; // Re-validate base inputs if needed

            // Gather all inputs again for consistency
            const keyword = keywordInput.value.trim();
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageOptions[languageSelect.value]?.name || languageSelect.value;
            const dialect = dialectSelect.disabled ? '' : dialectSelect.value;
            const audience = audienceInput.value.trim();
            const readerName = readerNameInput.value.trim();
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;
            const gender = genderSelect.value;
            const age = ageSelect.value;
            const selectedPurposes = getSelectedPurposes();
            const purposeDetails = {
                types: selectedPurposes,
                url: selectedPurposes.includes("Promote URL") ? purposeUrlInput.value.trim() : '',
                cta: purposeCtaInput.classList.contains('hidden') ? '' : purposeCtaInput.value.trim()
            };
            const format = formatSelect.value;
            const customSpecs = customSpecsInput.value.trim();

            // Prepare linking instructions
            let linkingInstructions = '';
            const linkType = linkTypeToggle.checked ? 'External (absolute URLs)' : 'Internal (relative URLs if possible, otherwise absolute)';
            if (parsedSitemapUrls.length > 0) {
                 const urlList = parsedSitemapUrls.slice(0, 20).join('\n');
                 linkingInstructions = `\n\nLinking Instructions:\n- Incorporate relevant links naturally into the article content where appropriate, using the following URLs as a reference pool.\n- Link Type Preference: ${linkType}.\n- Maximum 5-7 links total.\n\nAvailable URLs:\n${urlList}`;
            } else {
                 linkingInstructions = '\n\nLinking Instructions: No sitemap URLs provided.';
            }

            // Construct Prompt
            const prompt = `Generate a full article based on the following structure and specifications:
            - Keyword: "${keyword}"
            - Language: ${language}${dialect ? ` (${dialect} dialect)` : ''}
            - Target Audience: ${audience}
            - Tone: ${tone}
            ${gender ? `- Author Gender Persona: ${gender}` : ''}
            ${age ? `- Author Age Persona: ${age}` : ''}
            - Article Purpose(s): ${purposeDetails.types.join(', ')}
            ${purposeDetails.url ? `  - Promotional URL: ${purposeDetails.url}` : ''}
            ${purposeDetails.cta ? `  - Desired Call to Action: ${purposeDetails.cta}` : ''}
            ${readerName ? `- Address Reader As: ${readerName}` : ''}
            - Output Format: ${format}
            ${customSpecs ? `- Other Details: ${customSpecs}` : ''}

            Article Structure:
            ---
            ${structure}
            ---
            ${linkingInstructions}

            Format Instructions:
            - Write content for each section of the structure, ensuring coherence and flow.
            - Adhere strictly to the requested output format (${format}).
            ${format === 'html' ? '- For HTML: Use only basic text formatting tags like <p>, <h1>-<h6>, <ul>, <ol>, <li>, <b>, <i>, and <a> for links. Do NOT include <html>, <head>, <body>, or <div> tags.' : '- For Markdown: Use standard Markdown syntax including [link text](URL) for links.'}
            - Generate only the article content itself, without any introductory or concluding remarks about the generation process.`;

            const payload = {
                providerKey: getSelectedProviderKey(),
                model: aiModelSelect.value,
                prompt: prompt
            };
             logToConsole(`--- Generating Article Prompt ---\n${prompt}\n---------------------------------`);
            const result = await callAI('generate', payload, articleLoadingIndicator, generateArticleBtn);

            if (result && result.text) {
                generatedArticleTextarea.value = result.text;
                const isHtml = format === 'html';
                previewHtmlCheckbox.checked = false; previewHtmlCheckbox.disabled = !isHtml;
                previewHtmlCheckbox.parentElement.classList.toggle('hidden', !isHtml);
                generatedArticleTextarea.classList.remove('hidden');
                htmlPreviewDiv.classList.add('hidden'); htmlPreviewDiv.innerHTML = '';
                step3Section.classList.remove('hidden'); step4Section.classList.add('hidden');
            }
        });

        // Toggle Structure Visibility (Unchanged)
        toggleStructureVisibilityBtn.addEventListener('click', () => { const isHidden = structureContainer.classList.toggle('hidden'); toggleStructureVisibilityBtn.textContent = isHidden ? 'Show' : 'Hide'; });

         // HTML Preview Toggle (Unchanged)
        previewHtmlCheckbox.addEventListener('change', () => { /* ... (same as v4) ... */ const showPreview = previewHtmlCheckbox.checked; generatedArticleTextarea.classList.toggle('hidden', showPreview); htmlPreviewDiv.classList.toggle('hidden', !showPreview); if (showPreview) { let unsafeHTML = generatedArticleTextarea.value; let sanitizedHTML = unsafeHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, ''); htmlPreviewDiv.innerHTML = sanitizedHTML; logToConsole("Showing HTML preview. Basic script tag removal applied.", "warn"); } });

        // Step 3 -> Step 4: Enable Spinning (Unchanged)
        enableSpinningBtn.addEventListener('click', () => { /* ... (same as v4) ... */ spunArticleDisplay.innerHTML = generatedArticleTextarea.value; step4Section.classList.remove('hidden'); highlightSpintax(spunArticleDisplay); logToConsole("Spinning enabled.", 'info'); generatedArticleTextarea.classList.add('hidden'); htmlPreviewDiv.classList.add('hidden'); previewHtmlCheckbox.parentElement.classList.add('hidden'); previewHtmlCheckbox.checked = false; });


        // --- Text Selection and Spinning Logic ---
        let selectedTextInfo = null;
        spunArticleDisplay.addEventListener('mouseup', handleSelection);
        spunArticleDisplay.addEventListener('keyup', handleSelection);
        spunArticleDisplay.addEventListener('focus', handleSelection);

        function handleSelection() { /* ... (same as v4) ... */ const selection = window.getSelection(); if (selection && selection.rangeCount > 0) { const range = selection.getRangeAt(0); if (spunArticleDisplay.contains(range.commonAncestorContainer) && !range.collapsed) { const text = selection.toString().trim(); if (text.length > 0) { selectedTextInfo = { text: text, range: range.cloneRange() }; spinSelectedBtn.disabled = false; return; } } } selectedTextInfo = null; spinSelectedBtn.disabled = true; }

        spinSelectedBtn.addEventListener('click', async () => {
            if (!selectedTextInfo || !selectedTextInfo.text) { logToConsole("Spin button clicked but no valid text selected.", "warn"); return; }
            const textToSpin = selectedTextInfo.text;
            // Get language/tone again for spinning context (could simplify if needed)
            const language = languageSelect.value === 'custom' ? customLanguageInput.value.trim() : languageOptions[languageSelect.value]?.name || languageSelect.value;
            const dialect = dialectSelect.disabled ? '' : dialectSelect.value;
            const tone = toneSelect.value === 'custom' ? customToneInput.value.trim() : toneSelect.value;

            const prompt = `Take the following text and generate 2-4 variations that mean the same thing, suitable for spintax.\n- Language: ${language}${dialect ? ` (${dialect} dialect)` : ''}\n- Tone: ${tone} (Maintain this tone)\n- Output Format: Return ONLY the spintax string in the format {original|variation1|variation2|...}. Do not include the original text you were given unless it's one of the variations. Do not include any explanation or surrounding text.\n\nText to Spin:\n---\n${textToSpin}\n---`;

             const payload = {
                providerKey: getSelectedProviderKey(),
                model: aiModelSelect.value,
                prompt: prompt
            };
             logToConsole(`--- Spinning Text Prompt ---\n${prompt}\n---------------------------------`);
            const result = await callAI('generate', payload, spinActionLoadingIndicator, spinSelectedBtn);

            if (result && result.text) {
                // ... (Spintax insertion logic same as v4) ...
                const spintaxResult = result.text; const selection = window.getSelection(); if (selection && selectedTextInfo.range) { try { selection.removeAllRanges(); selection.addRange(selectedTextInfo.range); if (document.queryCommandSupported('insertHTML')) { document.execCommand('insertHTML', false, spintaxResult); } else if (document.queryCommandSupported('insertText')) { logToConsole("insertHTML not supported, using insertText.", "warn"); document.execCommand('insertText', false, spintaxResult); } else { selectedTextInfo.range.deleteContents(); selectedTextInfo.range.insertNode(document.createTextNode(spintaxResult)); } logToConsole(`Inserted spintax: ${spintaxResult}`, 'success'); highlightSpintax(spunArticleDisplay); } catch (e) { logToConsole(`Error replacing selection with spintax: ${e}`, 'error'); alert("Error applying spintax."); } finally { selectedTextInfo = null; spinSelectedBtn.disabled = true; selection.removeAllRanges(); } } else { logToConsole("Could not restore selection range.", 'error'); alert("Could not apply spintax."); spinSelectedBtn.disabled = true; }
            } else { spinSelectedBtn.disabled = true; }
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            populateLanguages(); // Populate languages first
            loadSitemapFromStorage();
            populateModels(); // Populate models (triggers dialect & API check)
            logToConsole("App initialized (v5 - More Specs). Ready for input.", 'info');
            logToConsole("API calls proxied via /ai-api.", 'info');
        });

    </script>

</body>
</html>
